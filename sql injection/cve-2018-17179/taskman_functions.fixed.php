<?php
// Original file: /interface/forms/eye_mag/php/taskman_functions.php

// ...
function make_task($ajax_req)
{
    global $send;
    $from_id    = $ajax_req['from_id'];
    $to_id      = $ajax_req['to_id'];
    $patient_id = $ajax_req['pid'];
    $doc_type   = $ajax_req['doc_type'];
    $doc_id     = $ajax_req['doc_id'];
    $enc        = $ajax_req['enc'];

    $query      = "SELECT * FROM users WHERE id=?";
    $to_data    =  sqlQuery($query, array($to_id));
    $filename   = "Fax_".$encounter."_".$to_data['lname'].".pdf";

    $query = "SELECT * FROM documents where encounter_id=? and foreign_id=? and url like ?";
    $doc = sqlQuery($query, array($encounter,$pid,'%'.$filename.'%' ));


    $sql = "SELECT * from form_taskman where FROM_ID=? and TO_ID=? and PATIENT_ID=? and ENC_ID=?";
    $task = sqlQuery($sql, array($from_id,$to_id,$patient_id,$enc));

    if (!$doc['ID'] && $task['ID'] && ($task['REQ_DATE'] < (time() - 60))) {
        // The task was requested more than a minute ago (prevents multi-clicks from "re-generating" the PDF),
        // but the document was deleted (to redo it)...
        // Delete the task, recreate the task, and send the newly made PDF.
        $sql = "DELETE from form_taskman where FROM_ID=? and TO_ID=? and PATIENT_ID=? and ENC_ID=?";
        $task = sqlQuery($sql, array($from_id,$to_id,$patient_id,$enc));
    }

    if ($task['ID'] && $task['COMPLETED'] =='2') {
        $send['comments'] = xlt('This fax has already been sent.')." ".
                            xlt('If you made changes and want to re-send it, delete the original (in Communications) and try again.')." ".
                            xlt('Filename').": ".$filename;
        echo json_encode($send);
        exit;
    } else if ($task['ID'] && $task['COMPLETED'] =='1') {
        if ($task['DOC_TYPE'] == 'Fax') {
            $send['DOC_link'] = "<a href='".$webroot."/openemr/controller.php?document&view&patient_id=".$task['PATIENT_ID']."&doc_id=".$task['DOC_ID']."'
								target='_blank' title='".xla('View the Summary Report sent to Fax Server.')."'>
								<i class='fa fa-file-pdf-o fa-fw'></i></a>
								<i class='fa fa-repeat fa-fw'
									onclick=\"top.restoreSession(); create_task('".attr($pat_data['ref_providerID'])."','Fax-resend','ref'); return false;\">
									</i>
							";
                            //add a resend option.
            $send['comments'] = xlt('This fax has already been sent.');
            echo json_encode($send);
            exit;
        } else if ($task['DOC_TYPE'] == "Fax-resend") {
            //we need to resend this fax????
            //You can only resend from here once.
            $send['comments'] = xlt('To resend, delete the file from Communications and try again.');
            echo json_encode($send);
            update_taskman($task, 'refaxed', '2');
            exit;
        } else { //DOC_TYPE is a Fax or Report
            $send['comments'] = xlt('Currently working on making this document')."...\n";
        }
    } else if (!$task['ID']) {
        /* By M3str3 <namestre3@protonmail.com>
        * [ CVE-2018-17179 ] 
        * Vulnerable code: this code is vulnerable because it does not use sanitization or prepared statements */
        $sql = "INSERT into form_taskman
                (REQ_DATE, FROM_ID, TO_ID, PATIENT_ID, DOC_TYPE, DOC_ID, ENC_ID) VALUES
                (NOW(), '$from_id', '$to_id', '$patient_id', '$doc_type', '$doc_id', '$enc')";
        sqlQuery($sql);
        /*  
        * CVE fixed:
        * Using prepared statements can easily fix the CVE */
        $sql = "INSERT into form_taskman
                (REQ_DATE, FROM_ID, TO_ID, PATIENT_ID, DOC_TYPE, DOC_ID, ENC_ID) VALUES
                (NOW(), ?, ?, ?, ?, ?, ?)";
        sqlQuery($sql, array($from_id, $to_id, $patient_id, $doc_type, $doc_id, $enc));
    } else {
        $send['comments'] = xlt('Currently working on making this document')."...\n";
    }
}
// ...