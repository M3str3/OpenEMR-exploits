<?php
// Original file: /interface/forms/eye_mag/php/taskman_functions.php

// ...
function &postcalendar_userapi_pcQueryEventsFA($args)
{

    $end = '0000-00-00';
    extract($args);
    $eventstatus = 1;
    if (is_numeric($event_status)) {
        $eventstatus = $event_status;
    }

    if (!isset($start)) {
        $start = Date_Calc::dateNow('%Y-%m-%d');
    }

    list($sy,$sm,$sd) = explode('-', $start);

    list($dbconn) = pnDBGetConn();
    $pntable = pnDBGetTables();
  // link to the events tables
    $table      =  $pntable['postcalendar_events'];
    $cattable   =  $pntable['postcalendar_categories'];

    /* By M3str3 <namestre3@protonmail.com>
    * [ CVE-2021-41843 ] 
    * Vulnerable code: This code is vulnerable because it does not use sanitization */
    $sql = "SELECT DISTINCT a.pc_eid, a.pc_informant, a.pc_catid, a.pc_title, 
            a.pc_time, a.pc_hometext, a.pc_eventDate, a.pc_duration, a.pc_endDate, 
            a.pc_startTime, a.pc_recurrtype, a.pc_recurrfreq, a.pc_recurrspec, 
            a.pc_topic, a.pc_alldayevent, a.pc_location, a.pc_conttel, 
            a.pc_contname, a.pc_contemail, a.pc_website, a.pc_fee, a.pc_sharing, 
            a.pc_prefcatid, b.pc_catcolor, b.pc_catname, b.pc_catdesc, a.pc_pid, 
            a.pc_aid, concat(u.fname,' ',u.lname) as provider_name, 
            concat(pd.fname,' ',pd.lname) as patient_name, 
            concat(u2.fname, ' ', u2.lname) as owner_name, pd.DOB as patient_dob, 
            a.pc_facility
            FROM $table AS a
            LEFT JOIN $cattable AS b ON b.pc_catid = a.pc_catid
            LEFT JOIN users as u ON a.pc_aid = u.id
            LEFT JOIN users as u2 ON a.pc_aid = u2.id
            LEFT JOIN patient_data as pd ON a.pc_pid = pd.pid
            WHERE a.pc_eventstatus = $eventstatus 
            AND (a.pc_endDate >= '$start' OR a.pc_endDate = '0000-00-00') 
            AND a.pc_eventDate <= '$end' 
            AND (a.pc_aid = '" . $provider_id . "' OR a.pc_aid = '')";
            
    /*  
    * CVE fixed:
    * Sanitizing user inputs using addslashes to prevent SQL injection attacks */
    $sql = "SELECT DISTINCT a.pc_eid, a.pc_informant, a.pc_catid, a.pc_title, 
            a.pc_time, a.pc_hometext, a.pc_eventDate, a.pc_duration, a.pc_endDate, 
            a.pc_startTime, a.pc_recurrtype, a.pc_recurrfreq, a.pc_recurrspec, 
            a.pc_topic, a.pc_alldayevent, a.pc_location, a.pc_conttel, 
            a.pc_contname, a.pc_contemail, a.pc_website, a.pc_fee, a.pc_sharing, 
            a.pc_prefcatid, b.pc_catcolor, b.pc_catname, b.pc_catdesc, a.pc_pid, 
            a.pc_aid, concat(u.fname,' ',u.lname) as provider_name, 
            concat(pd.fname,' ',pd.lname) as patient_name, 
            concat(u2.fname, ' ', u2.lname) as owner_name, pd.DOB as patient_dob, 
            a.pc_facility
            FROM $table AS a
            LEFT JOIN $cattable AS b ON b.pc_catid = a.pc_catid
            LEFT JOIN users as u ON a.pc_aid = u.id
            LEFT JOIN users as u2 ON a.pc_aid = u2.id
            LEFT JOIN patient_data as pd ON a.pc_pid = pd.pid
            WHERE a.pc_eventstatus = " . addslashes($eventstatus) . " 
            AND (a.pc_endDate >= '" . addslashes($start) . "' OR a.pc_endDate = '0000-00-00') 
            AND a.pc_eventDate <= '" . addslashes($end) . "' 
            AND (a.pc_aid = '" . addslashes($provider_id) . "' OR a.pc_aid = '')";

 /// ...
}
// ...
